"use strict";function ContentEditable(o){this.domElement=o;this.domElement.spellcheck=false;document.body.setAttribute("spellcheck","false");var r=this;function l(e,t){this.contentEditable=r;this.offset=0;if(e===undefined){e=window.getSelection().getRangeAt(0)}while(e instanceof Node&&e.nodeType==Node.TEXT_NODE&&e.parentNode!==o&&e.parentNode.parentNode!==o){e=e.parentNode}if(e instanceof l){this.line=e.line;this.offset=e.offset}else if(e instanceof Element||e instanceof Node){while(e.parentNode.tagName.toLowerCase()!="div"){e=e.parentNode}var n=0;var i=e;for(n=0;i=i.previousElementSibling;n++);if(e.parentNode!==o){this.offset=n;i=e.parentNode;for(n=0;i=i.previousElementSibling;n++);}this.line=n}else if(e instanceof Range){var s;if(t=="end"){var s=new l(e.endContainer);if(e.endOffset==0&&this.offset>0){s.offset--}}else{var s=new l(e.startContainer);if(e.startOffset==1&&this.offset>0){s.offset--}}this.line=s.line;this.offset=s.offset}else{this.line=e;if(t!==undefined){this.offset=t}}}l.prototype={span:function(){return this.div().children[this.offset]||this.div().childNodes[this.offset]},spanOffset:function(){var e=this.span();return this.offset==0?0:e.nodeType==Node.ELEMENT_NODE?e.childNodes.length:e.length},div:function(){return this.contentEditable.domElement.children[this.line]},lineLength:function(){return this.div().getElementsByTagName("span").length-1},right:function(e){if(e===undefined){e=1}var t=new l(this.line,this.offset);t.moveRight(e);return t},moveRight:function(e){if(e===undefined){e=1}if(e<0){this.moveLeft(-e);return}var t=this.contentEditable.lines();while(e>0){var n=this.lineLength();if(this.offset+e<=n){this.offset+=e;e=0}else{if(this.line+1<t){e+=this.offset-n-1;this.line++;this.offset=0}else{DEBUG&&DEBUG("could not move caret from "+this.line+","+this.offset+" by "+e+" chars to the right, because the content ends at "+this.line+","+n);this.offset=n;e=0}}}},moveDown:function(e){if(e===undefined){e=1}this.line+=e;if(this.line>=this.contentEditable.lines()){this.line=this.contentEditable.lines()-1}if(this.line<0){this.line=0;this.offset=0}else{this.offset=this.lineLength()}},moveUp:function(e){this.moveDown(-e);return},left:function(e){if(e===undefined){e=1}var t=new l(this.line,this.offset);t.moveLeft(e);return t},moveLeft:function(e){if(e===undefined){e=1}if(e<0){this.moveRight(-e);return}while(e>0){if(this.offset>=e){this.offset-=e;e=0}else{e-=this.offset+1;this.line++;this.offset=this.lineLength()}}},select:function(){var e=window.getSelection();if(this.offset==0){e.collapse(this.span().nextElementSibling,0)}else{e.collapse(this.span(),1)}},wholeLine:function(){return new a(this)}};this.getCursor=function(){return new l};function a(e){if(e===undefined){e=window.getSelection.getRangeAt(0)}if(e instanceof Node&&e.nodeType==Node.TEXT_NODE){e=e.parentNode}if(e instanceof l){this.index=e.line}else if(e instanceof Element){var t;var n=e;for(t=0;n=n.previousElementSibling;t++);if(e.tagName.toLowerCase()=="span"){n=e.parentNode;for(t=0;n=n.previousElementSibling;t++);}this.index=t}else{if(e==-1){e=r.domElement.children.length-1}this.index=e}}a.prototype={div:function(){return r.domElement.children[this.index]},length:function(){return g(this.div()).length-1},start:function(){return new l(g(this.div())[0])},end:function(){var e=g(this.div());return new l(e[e.length-1])},isLast:function(){return this.div().nextElementSibling===undefined},clearError:function(){this.div().removeAttribute("title")},setError:function(e){this.div().setAttribute("title",e)}};function f(e,t,n,i){if(n!==undefined){if(i===undefined){this.start=new l(e,t);if(n==-1){var s=r.domElement.children;s=s[s.length-1];s=s.getElementsByTagName("span");s=s[s.length-1];this.end=new l(s)}else{this.end=this.start.right(n)}}else{this.start=new l(e,t);this.end=new l(n,i)}}else if(e!==undefined&&!(e instanceof Range)){this.start=e;if(t instanceof l){this.end=t}else{this.end=this.start.right(t)}}else{var o=e;if(!(o instanceof Range)){if(window.getSelection){sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){o=sel.getRangeAt(0)}}else{throw new Error("Browser does not support window.getSelection.")}}this.start=new l(o);this.end=new l(o,"end")}this.deleteRangeContents=function(){var e=this.start.span();var t=e.nextElementSibling;if(this.start.line<this.end.line){while(e=t){t=e.nextElementSibling;e.parentNode.removeChild(e)}}else{while(this.end.offset>this.start.offset&&(e=t)){t=e.nextElementSibling;e.parentNode.removeChild(e);this.end.offset--}}var n=this.start.div();while(this.start.line+1<this.end.line){n.parentNode.removeChild(n.nextElementSibling);this.end.line--}if(this.start.line<this.end.line){var n=this.end.div();if(n){while(this.end.offset>0){n.removeChild(n.children[1]);this.end.offset--}while(n.children.length>1){n.previousElementSibling.appendChild(n.children[1])}n.parentNode.removeChild(n)}}this.end=new l(this.start)};this.appendNodesFromText=function(e){var t=this.end.span();e=e.split(/\r\n|\n|\r/);for(var n in e){if(n>0){var i=t.parentNode;var s=i.parentNode.insertBefore(document.createElement("div"),i.nextElementSibling);var o=s.appendChild(document.createElement("span"));s.appendChild(document.createElement("br"));o.appendChild(document.createTextNode(""));var r;while((r=t.nextElementSibling)&&r.tagName.toLowerCase()=="span"){s.appendChild(r)}t=o;this.end.moveRight()}for(var l=0;l<e[n].length;l++){var a=document.createElement("span");a.appendChild(document.createTextNode(e[n].charAt(l)));t.parentNode.insertBefore(a,t.nextElementSibling);t=a;this.end.moveRight()}}};this.text=function(){var e;var t="";var n,i;for(e=this.start.line;e<=this.end.line;e++){var s=new a(e);var o=document.createRange();o.selectNodeContents(r.domElement);if(e==this.start.line){n=this.start}else{n=s.start()}if(e==this.end.line){i=this.end}else{i=s.end()}o.setStart(n.span(),n.spanOffset());o.setEnd(i.span(),i.spanOffset());t+=o.toString();if(e!=this.end.line){t+="\n"}}return t}}function t(e){if(e.childNodes&&e.childNodes.length){return t(e.childNodes[0])}else{return e}}function n(e){if(e.childNodes&&e.childNodes.length){return n(e.childNodes[e.childNodes.length-1])}else{return e}}this.placeCaretAtStart=function(){DEBUG&&DEBUG("ContentEditable.placeCaretAtStart()");this.placeCaret(0,0)};this.placeCaretAtEnd=function(){DEBUG&&DEBUG("ContentEditable.placeCaretAtEnd()");var e=new a(-1);this.placeCaret(e.index,e.length())};this.placeCaret=function(e,t){if(e instanceof l){t=e.offset;e=e.line}DEBUG&&DEBUG("ContentEditable.placeCaret( "+e+", "+t+" )");this.setSelectionRange(e,t,0);this.focusSelection()};this.lines=function(){return r.domElement.children.length};this.focusSelection=function(){var e=new l;this.focus();var t=e.span();var n=r.domElement.getBoundingClientRect();var i=t.getBoundingClientRect();var s=0;if(i.top<n.top){s=i.top-n.top-1}if(i.top+(i.height||window.lineHight)>n.top+n.height){s=i.top+(i.height||window.lineHight)-(n.top+n.height)+1}if(s){r.domElement.scrollTop+=s}};this.replaceSelection=function(e){DEBUG&&DEBUG('ContentEditable.replaceSelection( "'+e+'" )');var t,n,i,s;n=new f;n.deleteRangeContents();n.appendNodesFromText(e);n.end.select()};this.setClass=function(e,t,n,i){DEBUG&&DEBUG("ContentEditable.setClass( "+e+", "+t+", "+n+', "'+i+'" )');var s=new l(e,t);while(n>0){s.moveRight();if(s.offset!=0){if(i===false){s.span().removeAttribute("class")}else{s.span().setAttribute("class",i)}}n--}};this.setDivClass=function(e,t){DEBUG&&DEBUG("ContentEditable.setClass( "+e+', "'+t+'" )');var n=new l(e,0);if(t===false){n.div().removeAttribute("class")}else{n.div().setAttribute("class",t)}};this.insertAtCaret=function(e){DEBUG&&DEBUG('ContentEditable.insertAtCaret( "'+e+'" )');this.replaceSelection(e)};function d(e){for(var t=0;e=e.previousElementSibling;t++);return t}this.getCaretPos=function(e){DEBUG&&DEBUG("ContentEditable.getCaretPos()");var t=window.getSelection();var n=t.focusOffset;var i;if(e==undefined){i=t.focusNode}else{var s=t.getRangeAt(0);if(e){i=s.startContainer;n=s.startOffset}else{i=s.endContainer;n=s.endOffset}}if(i.nodeType!=Node.ELEMENT_NODE){i=i.parentNode}result={line:0,offset:n};if(i){if(i.tagName.toLowerCase()=="span"||i.tagName.toLowerCase()=="br"){result.line=d(i.parentNode);result.offset+=d(i)-1}else if(i.tagName.toLowerCase()=="div"){if(i===o){if(n==0){result.line=0;result.offset=0}else{result.line=n-1;result.offset=new a(result.line).length()}}else{result.line=d(i);result.offset-=1}}}if(result.offset==-1){result.offset=0}DEBUG&&DEBUG("ContentEditable.getCaretPos: {"+result.line+", "+result.offset+"}");return result};this.getSelectionPos=function(){DEBUG&&DEBUG("ContentEditable.getSelectionPos()");var e={};e.start=this.getCaretPos(true);e.end=this.getCaretPos(false);DEBUG&&DEBUG("ContentEditable.getSelectionPos: { start: {"+e.start.line+", "+e.start.offset+"}, end: {"+e.end.line+", "+e.end.offset+"} }");return e};this.getSelectionLineLength=function(){DEBUG&&DEBUG("ContentEditable.getSelectionLineLength()");var e=this.getSelectionPos();var t=Math.abs(e.start.line-e.end.line)+1;DEBUG&&DEBUG("ContentEditable.getSelectionLineLength: {"+t+" }");return t};this.insertAt=function(e,t,n){DEBUG&&DEBUG("ContentEditable.insertAt( "+e+", "+t+', "'+n+'" )');var i=new f(e,t,e,t);i.appendNodesFromText(n)};this.remove=function(e,t,n){DEBUG&&DEBUG("ContentEditable.remove( "+e+", "+t+", "+n+" )");var i=new f(e,t,n);i.deleteRangeContents()};this.clear=function(){DEBUG&&DEBUG("ContentEditable.clear()");this.domElement.innerHTML="<div><span></span><br></div>";this.placeCaretAtStart()};this.setSelectionRange=function(e,t,n){DEBUG&&DEBUG("ContentEditable.setSelectionRange( "+e+", "+t+", "+n+" )");var i=window.getSelection();i.removeAllRanges();i.addRange(this.createSelectionRange(e,t,n))};this.getSelectionRange=function(){this.domElement.focus();return window.getSelection.getRangeAt(0)};function e(e){var t,n=[],i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,false);while(t=i.nextNode())n.push(t);return n}function i(e,t){var n=0;for(;;){if(!e.childNodes.length){e}while(!e.previousSibling){e=e.parentNode;if(!e){throw new Error("Node was not inside the contenteditable Dom element.")}if(e==r.domElement){return n+t}}e=e.previousSibling;while(e.nodeType==Node.ELEMENT_NODE){e=e.childNodes[e.childNodes.length-1]}if(e.nodeType==Node.TEXT_NODE){n+=e.data.length}}}function s(e,t){var n;n=r.domElement;while(n.childNodes.length){n=n.childNodes[0]}for(;;){if(n.nodeType==Node.TEXT_NODE){var i=n.data.length;if(i>=pos){return{node:n,offset:pos}}else{pos-=i}}while(!n.nextSibling){n=n.parentNode}n=n.nextSibling;while(n.childNodes.length){n=n.childNodes[0]}}}function h(e,t,n){var i={start:undefined,end:undefined};var s=new l(e,t);i.start={node:s.span(),offset:s.offset>0?1:0};if(n==-1){e=r.domElement.children.length-1;t=0;s=new l(e,t);s.offset+=s.lineLength()}else{s.moveRight(n)}i.end={node:s.span(),offset:s.offset>0?1:0};return i}this.createSelectionRange=function(t,n,e){DEBUG&&DEBUG("ContentEditable.createSelectionRange( "+t+", "+n+", "+e+" )");if(document.createRange&&window.getSelection){var i=document.createRange();i.selectNodeContents(this.domElement);var s=h(t,n,e);try{i.setStart(s.start.node,s.start.offset);i.setEnd(s.end.node,s.end.offset)}catch(e){if(e instanceof DOMException){DEBUG&&DEBUG("cant place cursor on not (jet) existiong position: "+t+", "+n)}else{throw e}}return i}else{throw new Error("Browser does not support window.getSelection.")}};this.getText=function(e,t,n){if(e===undefined){e=0}if(t===undefined){t=0}if(n===undefined){n=-1}DEBUG&&DEBUG("ContentEditable.getText( "+e+", "+t+", "+n+" )");var i=new f(e,t,n).text();DEBUG&&DEBUG('ContentEditable.getText : "'+i+'"');return i};this.focus=function(){this.domElement.focus()};this.clearAllErrors=function(){this.forAllLines(function(e){e.clearError()})};this.forAllLines=function(e){var t=this.lines();for(var n=0;n<t;n++){e(new a(n))}};this.getTextLength=function(){DEBUG&&DEBUG("ContentEditable.getTextLength()");var t=-1;this.forAllLines(function(e){t+=e.length()+1});DEBUG&&DEBUG("ContentEditable.getTextLength: "+t);return t};function c(e){return element.parentNode.parentNode===r.domElement&&(e.nodeType===Node.ELEMENT_NODE&&e.tagName.toLowerCase()!=="br"||e.nodeType===Node.TEXT_NODE&&e.length)}function u(e){return element.parentNode===r.domElement}function E(e){while(e.parentNode!==r.domElement){e=e.parentNode}return e}function g(e){e=E(e);var t=[];var n=e.childNodes;for(var i=0;i<n.length;i++){if(n[i].nodeType===Node.ELEMENT_NODE&&n[i].tagName.toLowerCase()!=="br"||n[i].nodeType===Node.TEXT_NODE&&n[i].length){t.push(n[i])}}return t}}