"use strict";function CalcTape(){var p=this;var e=1111..toLocaleString().replace(/1/g,"");var t=1.1.toLocaleString().replace(/1/g,"");var i=500;var o=0;this.linesWarning=document.getElementById("lines_warning");this.linesWarningNumber=document.getElementById("numlines");this.linesCurrent=document.getElementById("curline");var n=document.getElementById("editor");var r=document.getElementById("desktop");var a=document.getElementById("mobile");this.inserting=0;this.pad=new Module.JSCalcPad(t,e,1);this.contentEditable=new ContentEditable(n);this.externalEditor=new Editor(this.contentEditable,this.pad);this.editorImplementation=Module.SFRCalcAbstractExternalTextEditor.implement(this.externalEditor);this.pad.setExternalTextEditor(this.editorImplementation);this.buttonController=new Module.ButtonController(this.pad);this.buttonController.checkSystemUserButtons(parseFloat(tr(["tax","percent"])),tr(["tax","label"]),"","");this.keyboard=new Keyboard(r,Module.AllKeyboardLayouts.getDefault(),this.buttonController);this.mobileKeyboard=new Keyboard(a,Module.AllKeyboardLayouts.getWebMobile(),this.buttonController);for(var s=0;s<this.keyboard.keys.length;s++){if(this.keyboard.keys[s].element.getAttribute("data-value")=="MR"){this.keyboard.keys[s].updateValue=function(){var e=p.pad.getCurrentMemoryValue();this.element.innerHTML='<div class="m_function">MR</div><div class="m_number">'+E(e,12,1)+"</div>";this.element.setAttribute("title",e)}}else if(this.keyboard.keys[s].element.getAttribute("data-value")=="M+"){this.keyboard.keys[s].updateValue=function(){var e=p.pad.getCurrentMemoryValue();var t=p.pad.getAddMemoryHint();this.element.innerHTML='<div class="m_function">M+</div><div class="m_number">'+E(t,12,1)+"</div>";this.element.setAttribute("title",e+t)}}else if(this.keyboard.keys[s].element.getAttribute("data-value")=="M-"){this.keyboard.keys[s].updateValue=function(){var e=p.pad.getCurrentMemoryValue();var t=p.pad.getAddMemoryHint();var t=p.pad.getSubtractMemoryHint();this.element.innerHTML='<div class="m_function">M-</div><div class="m_number">'+E(t,12,1)+"</div>";this.element.setAttribute("title",e+t)}}}this.keyboard.updateValues();this.storage=new CalcStorage;this.ignoreInput=false;var l=new Dialog({onYes:function(){window.open(tr(["dialog","open_with","url"]))},id:"open_with"});this.menu=new Menu(document.getElementById("menuicon"),document.getElementById("menulist"),document.getElementById("navigation"));this.menu.entry({shortcut:"s",label:tr("save_as"),icon:tr(["save_as","icon"])},function(){p.download();l.open()});this.menu.entry({shortcut:"z",label:tr("undo"),icon:tr(["undo","icon"]),active:function(){return p.pad.isUndoAvailable()}},function(){p.undo();p.updateButtons();p.updateStatusBar()});this.menu.entry({shortcut:"y",label:tr("redo"),icon:tr(["redo","icon"]),active:function(){return p.pad.isRedoAvailable()}},function(){p.redo();p.updateButtons();p.updateStatusBar()});if(localStorage.getItem("lined")=="on"){document.getElementById("wrapper").setAttribute("class","showlines")}this.menu.onoff({shortcut:"l",label:tr(["showlines"]),icon:tr(["showlines","icon"]),isActive:localStorage.getItem("lined")=="on"},function(){document.getElementById("wrapper").addClass("showlines");localStorage.setItem("lined","on")},function(){document.getElementById("wrapper").removeClass("showlines");localStorage.setItem("lined","off")});if(localStorage.getItem("spellcheck")=="on"){p.contentEditable.domElement.spellcheck=true;document.body.setAttribute("spellcheck","true")}else{p.contentEditable.domElement.spellcheck=false;document.body.setAttribute("spellcheck","false")}this.menu.value({shortcut:"n",label:tr("memory_to_clipboard"),icon:tr("current_memory"),value:function(){return E(p.pad.getCurrentMemoryValue()||"0",16,1)}},function(){p.toClipboard(p.pad.getCurrentMemoryValue()||"0")});this.menu.value({shortcut:"n",label:tr("sum_to_clipboard"),icon:tr("current_sum"),value:function(){return E(p.pad.getCurrentResult()||"-",19,1)}},function(){p.toClipboard(p.pad.getCurrentResult()||"-")});this.updateLineHeight=function(e){e=e||100;var t="&nbsp;";for(var n=1;n<e;n++){t+="<br/>&nbsp;"}var r=document.createElement("div");var a=document.createElement("div");r.setAttribute("class","editor");a.setAttribute("class","editor");r.innerHTML=t;a.innerHTML=t+"<br/>"+t;document.getElementById("wrapper").appendChild(r);document.getElementById("wrapper").appendChild(a);var i=(a.scrollHeight-r.scrollHeight)/e;r.remove();a.remove();document.getElementById("editor").setAttribute("style","background-size: "+i*2+"px "+i+"px;");window.lineHight=i};setTimeout(function(){p.updateLineHeight()},1);var d;d=parseInt(localStorage.getItem("size"))||u();document.documentElement.style.fontSize=d+"px";function u(){return Math.max(Math.min(Math.round(window.screen.width/40),16),8)||16}var c=function(){if(window.innerWidth/d<58||window.innerHeight/d<26){document.documentElement.addClass("nomenubar");document.documentElement.removeClass("menubar")}else{document.documentElement.removeClass("nomenubar");document.documentElement.addClass("menubar")}if(window.innerWidth/d<41.25){document.documentElement.addClass("mobilekeypad")}else{document.documentElement.removeClass("mobilekeypad")}if(window.innerWidth/d>45){document.documentElement.addClass("maxheadline")}else{document.documentElement.removeClass("maxheadline")}if(window.innerHeight/d<42){document.documentElement.addClass("shrinkkeys")}else{document.documentElement.removeClass("shrinkkeys")}p.updateLineHeight();p.contentEditable.focusSelection()};window.addEventListener("resize",c);this.menu.entry({shortcut:"2",label:tr("zoom_in"),icon:tr(["zoom_in","icon"]),active:function(){return d<48}},function(){if(d<48){p.zoomTo(d+1)}});this.menu.entry({shortcut:"1",label:tr("zoom_out"),icon:tr(["zoom_out","icon"]),active:function(){return d>6}},function(){if(d>6){p.zoomTo(d-1)}});this.zoomTo=function(e){if(e===undefined){e=u()}d=e;document.documentElement.style.fontSize=d+"px";localStorage.setItem("size",d);p.updateLineHeight();p.updateButtons();p.updateStatusBar()};this.menu.entry({label:tr("help"),icon:tr(["help","icon"])},function(){p.pad.setCaretPos(0,false);p.insertText(tr(["example_text",t,e]));p.pad.reFormatAll();p.placeCaret(0,0);p.updateStatusBar()});this.menu.link({label:tr("manual"),icon:tr(["manual","icon"]),target:"_blank"},tr(["manual","url"]));this.links=new Menu(document.getElementById("menuicon"),document.getElementById("linkslist"),document.getElementById("navigation"));this.links.link({label:tr("mac"),icon:tr(["mac","icon"]),target:"_blank"},tr(["mac","url"]));this.links.link({label:tr("windows"),icon:tr(["windows","icon"]),target:"_blank"},tr(["windows","url"]));this.links.link({label:tr("android"),icon:tr(["android","icon"]),target:"_blank"},tr(["android","url"]));this.links.link({label:tr("ios"),icon:tr(["ios","icon"]),target:"_blank"},tr(["ios","url"]));this.links.link({label:tr("enterprise"),icon:tr(["enterprise","icon"]),target:"_blank"},tr(["enterprise","url"]));this.share=new Menu(document.getElementById("shicon"),document.getElementById("shlist"),document.getElementById("shnav"));this.share.link({label:tr(["share","linkedin","label"]),icon:tr(["share","linkedin","icon"]),target:"_blank"},tr(["share","linkedin","url"]));this.share.link({label:tr(["share","xing","label"]),icon:tr(["share","xing","icon"]),target:"_blank"},tr(["share","xing","url"]));if(window.sidebar&&window.sidebar.addPanel||window.external&&window.external.AddFavorite){this.share.entry({label:tr(["share","bookmark","label"]),icon:tr(["share","bookmark","icon"]),shortcut:"d",target:"_blank"},function(){if(window.sidebar&&window.sidebar.addPanel){window.sidebar.addPanel(tr(["calctape","web"]),tr("this_url"),"")}else if(window.external&&window.external.AddFavorite){window.external.AddFavorite(tr("this_url"),tr(["calctape","web"]))}})}var m=new Dialog({onYes:function(){window.location.href=tr(["dialog","forward_to_apps","url"])},remember:DialogRemember.CHOOSE_STORE_USED,id:"forward_to_apps"});var h=new Dialog({no:false,id:"to_many_lines"});if(window.screen.width<1024-1||window.screen.height<720-1||"ontouchstart"in document.documentElement){m.open()}this.allowBlur=false;n.onblur=function(){DEBUG&&DEBUG("ANDROID blur");setTimeout(function(){p.focusEditor()},1)};this.placeCaret=function(e,t){p.contentEditable.placeCaret(e,t);p.pad.clearSelection()};this.focusEditor=function(){p.allowBlur=false;var e=this.pad.getCaretPos();p.placeCaret(p.pad.convertCaretPosToLineIndex(e),p.pad.convertCaretPosToOffset(e));p.contentEditable.focus()};this.insertText=function(e){p.changeContent(function(){DEBUG&&DEBUG('SFRCalcPad.insertTextAtCurrentPosition("'+e+'")');p.pad.insertTextAtCurrentPosition(e,false,false)})};this.undo=function(){p.changeContent(function(){p.pad.undo()},true)};this.redo=function(){p.changeContent(function(){p.pad.redo()},true)};this.changeContent=function(e,t){try{p.inserting++;t||p.pad.beginUndoTransaction();e();var n=this.pad.getCaretPos();DEBUG&&DEBUG("SFRCalcPad.getCaretPos() : "+n);p.placeCaret(p.pad.convertCaretPosToLineIndex(n),p.pad.convertCaretPosToOffset(n));p.contentEditable.focus()}finally{p.inserting--;t||p.pad.endUndoTransaction()}p.updateButtons();p.updateErrors();p.updateStatusBar();p.updateMaxLines();p.save()};this.updateErrors=function(){if(this.pad.containsErrors()){this.hadErrors=true;this.contentEditable.forAllLines(function(e){var t=p.pad.getError(e.index);var n=f(t);if(n=="None"||t===undefined){e.clearError()}else{e.setError(tr(["error","line",n])+" (E"+t.value+")")}})}else if(this.hadErrors){this.contentEditable.clearAllErrors();this.hadErrors=false}};this.updateStatusBar=function(){var e="";var t=this.pad.convertCaretPosToLineIndex(this.pad.getCaretPos());var n=this.pad.convertCaretPosToOffset(this.pad.getCaretPos());var r=p.pad.getCurrentMemoryValue()||"0";e+='<span title="'+tr(["statusbar","memory","title"])+'" onclick="window.calctape.toClipboard(\''+r+"')\">"+tr(["statusbar","memory","label"])+": "+r+"</span>";e+=' | <span title="'+tr([Math.round(d*100/16)+"%","statusbar","zoom","title"])+'" onclick="window.calctape.zoomTo()">'+tr(["statusbar","zoom","label"])+": "+Math.round(d*100/16)+"%</span>";e+=" | "+tr(["statusbar","cursor","label"])+": "+t+":"+n;var a=p.pad.getError(t);var i=f(a);if(i!="None"){e+=' | <span class="error">'+tr(["error","line",i])+"</span>"}document.getElementById("status_text").innerHTML=e};this.updateMaxLines=function(){o=this.contentEditable.lines();if(o>=i*.95){if(o>=i){this.linesWarning.addClass("error")}else{this.linesWarning.removeClass("error")}this.linesWarning.removeClass("hidden");this.linesWarningNumber.innerText=o}else{this.linesWarning.addClass("hidden")}};function f(e){switch(e){case Module.SFRCalcErrorType.ERR_DivideByZero:return"DivideByZero";case Module.SFRCalcErrorType.ERR_DoubleOperator:return"DoubleOperator";case Module.SFRCalcErrorType.ERR_IntermediateResultRequiredAfterPercentCalculation:return"IntermediateResultRequiredAfterPercentCalculation";case Module.SFRCalcErrorType.ERR_InvalidCalculation:return"InvalidCalculation";case Module.SFRCalcErrorType.ERR_InvalidStartOperator:return"InvalidStartOperator";case Module.SFRCalcErrorType.ERR_InvalidVarName:return"InvalidVarName";case Module.SFRCalcErrorType.ERR_LValueVariableDefinitionOnlyAllowedInSums:return"LValueVariableDefinitionOnlyAllowedInSums";case Module.SFRCalcErrorType.ERR_PercentDefinition:return"PercentDefinition";case Module.SFRCalcErrorType.ERR_PercentWithoutValue:return"PercentWithoutValue";case Module.SFRCalcErrorType.ERR_SyntaxError:return"SyntaxError";case Module.SFRCalcErrorType.ERR_UnknownFunction:return"UnknownFunction";case Module.SFRCalcErrorType.ERR_VariableAlreadyDefined:return"VariableAlreadyDefined";case Module.SFRCalcErrorType.ERR_VariableDefinitionError:return"VariableDefinitionError";case Module.SFRCalcErrorType.ERR_VariableValueUndefined:return"VariableUndefined";case Module.SFRCalcErrorType.ERR_VariableUndefined:return"VariableValueUndefined";case Module.SFRCalcErrorType.ERR_None:default:return"None"}}this.checkCaret=function(){DEBUG&&DEBUG("CalcTape.checkCaret( "+n+", "+true+" )");var e=window.getSelection();DEBUG&&DEBUG("CalcTape.checkCaret( "+e+" )");if(e){var t=p.contentEditable.getCaretPos();var n=p.pad.convertCaretLineIndexAndOffsetToPos(t.line,t.offset);DEBUG&&DEBUG("SFRCalcPad.setCaretPos( "+n+", "+true+" )");p.pad.setCaretPos(n,true);var r=p.contentEditable.getSelectionPos();p.pad.setSelectionStart(r.start.line,r.start.offset);p.pad.setSelectionEnd(r.end.line,r.end.offset)}else{DEBUG&&DEBUG("!!!!!!!! window.getSelection() is undefined !!!!!!!!"+e+" )")}p.updateButtons();p.updateStatusBar()};document.addEventListener("keypress",function(e){DEBUG&&DEBUG("ANDROID keypress: "+JSON.stringify(String.fromCharCode(e.which)));p.updateButtons();if(!e.ctrlKey&&!e.altKey&&!e.metaKey&&e.which){var t=String.fromCharCode(e.which);p.insertText(t);e.preventDefault();e.stopPropagation();return false}setTimeout(function(){p.checkCaret()},1)});document.addEventListener("compositionstart",function(e){DEBUG&&DEBUG("ANDROID start data: "+JSON.stringify(e.data))});document.addEventListener("compositionupdate",function(e){DEBUG&&DEBUG("ANDROID update data: "+JSON.stringify(e.data))});document.addEventListener("compositionend",function(e){DEBUG&&DEBUG("ANDROID end data: "+JSON.stringify(e.data))});document.addEventListener("textInput",function(e){DEBUG&&DEBUG("ANDROID textInput: "+JSON.stringify(e.data))});document.addEventListener("keyup",function(e){DEBUG&&DEBUG("ANDROID keyup event: "+JSON.stringify(e.which));if(!p.inserting&&e.which!=229){p.checkCaret()}});document.addEventListener("mouseup",function(){if(!p.inserting){window.setTimeout(function(){p.checkCaret()},1)}});document.addEventListener("keydown",function(e){DEBUG&&DEBUG("ANDROID keydown event: "+JSON.stringify(e.code||e.key));if(e.ctrlKey||e.metaKey){var t=String.fromCharCode(e.which).toUpperCase();for(s in p.menu.entries){if(t==p.menu.entries[s].shortcut){p.menu.entries[s].action();e.preventDefault();e.stopPropagation();return false}}if(String.fromCharCode(e.which).toLowerCase()=="o"){document.getElementById("fileInput").click();e.preventDefault();e.stopPropagation();return false}return true}if((e.code||e.key).toLowerCase()=="delete"){p.insertText(String.fromCharCode(24));e.preventDefault();e.stopPropagation();return false}if((e.code||e.key).toLowerCase()=="backspace"){p.insertText(String.fromCharCode(8));e.preventDefault();e.stopPropagation();return false}});this.pad.setText(this.storage.load("calc","scratchpad")||tr(["example_text",t,e]));this.handlePaste=function(e){var t=e.clipboardData||window.clipboardData;var n=t.getData("Text");var r=(n.match(/\r\n|\r|\n/g)||"").length+1;var a=p.contentEditable.getSelectionLineLength();if(o-a+r<=i){p.insertText(n)}else{h.open()}e.stopPropagation();e.preventDefault();return false};n.addEventListener("paste",this.handlePaste);n.addEventListener("input",function(e){DEBUG&&DEBUG("ANDROID input event: "+JSON.stringify(p.contentEditable.getText()));if(!p.ignoreInput){window.setTimeout(function(){var e=p.contentEditable.getText();p.ignoreInput=true;DEBUG&&DEBUG('document.execCommand("undo")');document.execCommand("undo");p.ignoreInput=false;if((e.match(/\r\n|\r|\n/g)||"").length+1<i){p.emulateChanges(e)}else{h.open()}},1)}});this.emulateChanges=function(e){DEBUG&&DEBUG("CalcTape.emulateChanges()");var t=this.contentEditable.getText();DEBUG&&DEBUG("oldText:"+"\n\n"+t+"");DEBUG&&DEBUG("newText:"+"\n\n"+e+"");var n=Math.max(e.length,t.length);var r=e.length-t.length;var a,i,o=-1,s,l;for(a=0;a<n;a++){if(t[a]!==e[a]){o=a;s=a+Math.max(0,-r);l=a+Math.max(0,r);for(i=t.length-1;i>=o;i--){if(t[i]!==e[i+r]){s=i+1;l=i+r+1;break}}break}}if(o!=-1){var d=p.contentEditable.getSelectionPos();var u=p.pad.convertCaretLineIndexAndOffsetToPos(d.start.line,d.start.offset);var c=p.pad.convertCaretLineIndexAndOffsetToPos(d.end.line,d.end.offset);var m=o;if(o>=u){m=u;if(s<=c||t.substring(c,s)===e.substring(c-(l-s),l)){if(l+c-s>=u){l+=c-s;s=c;o=m}}}if(u===o&&c===s){this.insertText(e.substring(o,l));return}var h=e.substring(o,l);p.changeContent(function(){p.pad.setCaretPos(o,false);var e=p.pad.convertCaretPosToLineIndex(o);var t=p.pad.convertCaretPosToOffset(o);p.pad.setSelectionStart(e,t);e=p.pad.convertCaretPosToLineIndex(s);t=p.pad.convertCaretPosToOffset(s);p.pad.setSelectionEnd(e,t);p.pad.insertTextAtCurrentPosition(h,false,false)})}};n.focus();this.moveCaret=function(e,t){e.focus();var n,r;if(window.getSelection){n=window.getSelection();var a=n.focusNode;var i=n.focusOffset+t;while(i<0){if(!a.previousSibling){i=0}else if(a.previousSibling.nodeType!=Node.TEXT_NODE){a=a.previousSibling}else{a=a.previousSibling;i+=a.data.length}}while(i>a.data.length){if(!a.nextSibling){i=a.data.length}else if(a.nextSibling.nodeType!=Node.TEXT_NODE){a=a.nextSibling}else{i-=a.data.length;a=a.nextSibling}}n.collapse(a,Math.min(a.length,i))}else{throw new Error("Browser does not support window.getSelection.")}};this.insertFromButton=function(e){p.changeContent(function(){p.pad.pressButton(e.getAttribute("data-value"))});p.keyboard.updateValues()};this.save=function(){this.storage.save("calc","scratchpad",this.pad.getText("\n"))};this.download=function(){var e=new Module.JSUrlencodedOutputStream;this.pad.saveToStream(e,"scratchpad.calc");var t=new Date;this.storage.download("calc",tr("filename")+t.toLocaleString(),e.toString())};var g=document.getElementById("fileInput");g.addEventListener("change",function(e){var t=g.files[0];var n=/text.*/;var r=new FileReader;r.onload=function(e){p.pad.setText(r.result)};r.readAsText(t)});this.clear=function(){p.pad.setText("");p.contentEditable.clear()};this.toClipboard=function e(t){this.allowBlur=true;var n=document.getElementById("hiddeninput");n.setAttribute("value",t);n.focus();n.select();document.execCommand("copy");this.focusEditor()};this.updateButtons=function(){this.menu.update();this.keyboard.updateValues()};this.updateButtons();this.hadErrors=true;this.updateErrors();this.updateStatusBar();this.updateMaxLines();c();function E(e,t,n,r){if(n===undefined){n=.5}if(r===undefined){r="â€¦"}if(e.length>t){var n=Math.floor((t-2)*n);var a=-(t-2-n)||e.length;e=e.substr(0,n)+r+e.substr(a)}return e}}window.DEBUG=window.DEBUG?function(e){console.log("["+Date.now()%1e4+"ms] "+e)}:false;